---
title: "FENG, SIYUAN, 31625937 - Homework 3"
author: "FENG, SIYUAN, 31625937"
output: html_document
---

Please read all instructions carefully.  Fill in all fields above (Espicially your student number) and remove square brackets. To allow this file to be knit, you might need to save it in a new location, as you do not have write permissions in the dropbox folder, and R does not work well with Chinese characters.
Do not comment out the lines that produce output.  Check your html file before submission to ensure it has all relevant output. Do not delete anything below these instructions.  Thank you! 



**Question 1A:**
```{r Question 1A}
####################  Load Dataset  ###########################

setwd("~/Desktop/MKT436R MKT ANALYTICS  /Assignment/Homework3")
library(readr)
RawData1B <- read_csv("Student Data 7.csv")
RawData1A <- RawData1B
RawData1A$expenditure <- NULL


############### Descriptive Analysis ##########################

## Check the linear relationships
anova(lm(card~.,data = RawData1A))
anova(lm(card~.^2,data = RawData1A))

## Using BIC to find the simplest model
library('leaps')
basicSubset = regsubsets(card~.,data = RawData1A)
basicSummary = summary(basicSubset)
bestBIC = which.min(basicSummary$bic)
coef(basicSubset,bestBIC)

basicSubset2 = regsubsets(card~.^2,data = RawData1A,really.big=T)
basicSummary2 = summary(basicSubset2)
bestBIC2 = which.min(basicSummary2$bic)
coef(basicSubset2,bestBIC2)

## check the nonlinear relationship
library(earth)
plotmo(earth(card~.,data = RawData1A))
plotmo(earth(card~.,data = RawData1A,degree = 2))


############### K-fold Cross Validation ########################

## Randomly choose which fold each row is in
set.seed(1)
nFold = 10
valNum = floor(runif(nrow(RawData1A))*nFold)+1

## Function returns k-fold cross validation error 
RMSE <- function(modelCall){
    modelPerformance <- rep(NA,nFold)
    for(fold in 1:nFold){
        # Get the training and validation data for this fold
        trainingData <- subset(RawData1A,valNum!=fold)
        validationData <- subset(RawData1A,valNum==fold)
        # Estimate the model for this training data
        model <- update(modelCall,data=trainingData)
        # Calculate out of sample MSE for this validationData
        validRMSE <- mean((validationData$card - predict(model,validationData))^2)^.5
        # Store model performance		
        modelPerformance[fold] <- validRMSE
    }
    return(mean(modelPerformance))
}

######### Models
## Linear models
lm1 = lm(card~.,data = RawData1A)
lm2 = lm(card~reports+income+share+owner+selfemp+dependents+majorcards+active,
         data = RawData1A)
lm3 = lm(card~reports+share+owner+selfemp+majorcards,data = RawData1A)
lm4 = lm(card~.^2,data = RawData1A)
lm5 = lm(card~.+reports*share+reports*months+reports*active+share*majorcards,
         data = RawData1A)
lm6 = lm(card~.+reports*share+income*owner+reports*active+share*majorcards,
         data = RawData1A)
lm7 = lm(card~reports+income+share+owner+selfemp+dependents+majorcards+active+
             reports*share+reports*months+reports*active+share*majorcards,data = RawData1A)


## MARS models
earth1<- earth(card~.,data = RawData1A)
earth2<- earth(card~reports+income+share+age+majorcards+active,data = RawData1A)
earth3<- earth(card~.,data = RawData1A,degree = 2)
earth4<- earth(card~.,data = RawData1A,degree = 2, thres = 0.0001)
earth5<- earth(card~.,data = RawData1A,degree = 2, thres = 0.01)
earth6<- earth(card~.,data = RawData1A,degree = 2, thres = 0.1)
earth7<- earth(card~.+reports*share+age*share+income*share+share*majorcards+share*active,data = RawData1A)

############### Store all the results ############################
AllRMSE<-data.frame(
    model=c('lm1','lm2','lm3','lm4','lm5','lm6','lm7',
            'earth1','earth2','earth3','earth4','earth5','earth6','earth7'), 
    results=c(RMSE(lm1),RMSE(lm2),RMSE(lm3),RMSE(lm4),RMSE(lm5),RMSE(lm6),RMSE(lm7),RMSE(earth1),
              RMSE(earth2),RMSE(earth3),RMSE(earth4),RMSE(earth5),RMSE(earth6),RMSE(earth7)))

############### Estimate on the full dataset #####################
chosenModel<-earth(card~.,data = RawData1A,degree = 2)
chosenModel
```



**Question 1B:**
```{r Question 1B}
############### Descriptive Analysis ##########################

## Check the linear relationships
anova(lm(card~.,data = RawData1B))
anova(lm(card~.^2,data = RawData1B))

## Using BIC to find the simplest model
library('leaps')
basicSubset = regsubsets(card~.,data = RawData1B)
basicSummary = summary(basicSubset)
bestBIC = which.min(basicSummary$bic)
coef(basicSubset,bestBIC)

basicSubset2 = regsubsets(card~.^2,data = RawData1B,really.big=T)
basicSummary2 = summary(basicSubset2)
bestBIC2 = which.min(basicSummary2$bic)
coef(basicSubset2,bestBIC2)

## check the nonlinear relationship
library(earth)
plotmo(earth(card~.,data = RawData1B))
plotmo(earth(card~.,data = RawData1B,degree = 2))


############### K-fold Cross Validation ########################

## Randomly choose which fold each row is in
set.seed(1)
nFold = 10
valNum = floor(runif(nrow(RawData1B))*nFold)+1

## Function returns k-fold cross validation error 
RMSE <- function(modelCall){
    modelPerformance <- rep(NA,nFold)
    for(fold in 1:nFold){
        # Get the training and validation data for this fold
        trainingData <- subset(RawData1B,valNum!=fold)
        validationData <- subset(RawData1B,valNum==fold)
        # Estimate the model for this training data
        model <- update(modelCall,data=trainingData)
        # Calculate out of sample MSE for this validationData
        validRMSE <- mean((validationData$card - predict(model,validationData))^2)^.5
        # Store model performance		
        modelPerformance[fold] <- validRMSE
    }
    return(mean(modelPerformance))
}

######### Models
## Linear models
lm1 = lm(card~.,data = RawData1B)
lm2 = lm(card~reports+income+share+expenditure+owner+selfemp+dependents+majorcards+active,
         data = RawData1B)
lm3 = lm(card~reports+share+expenditure+owner+dependents+majorcards+active,data = RawData1B)
lm4 = lm(card~.^2,data = RawData1B)
lm5 = lm(card~.+reports*expenditure+share*expenditure+expenditure*active+
             majorcards*expenditure,data = RawData1B)
lm6 = lm(card~.+reports*share+reports*expenditure+reports*months+reports*selfemp+
             reports*active+share*majorcards+income*expenditure+age*expenditure+
             share*expenditure+expenditure*selfemp,data = RawData1B)

## MARS models
earth1<- earth(card~.,data = RawData1B)
earth2<- earth(card~reports+share+expenditure+active+income+selfemp+owner+dependents
               +majorcards,data = RawData1B)
earth3<- earth(card~.,data = RawData1B,degree = 2)
earth4<- earth(card~.,data = RawData1B,degree = 2, thres = 0)
earth5<- earth(card~.,data = RawData1B,degree = 2, thres = 0.01)
earth6<- earth(card~.,data = RawData1B,degree = 2, thres = 0.1)
earth7<- earth(card~.+reports*share+age*share+income*share+share*majorcards+share*active+age*expenditure+share*expenditure+expenditure*active,data = RawData1B)

############### Store all the results ############################
AllRMSE<-data.frame(
    model=c('lm1','lm2','lm3','lm4','lm5','lm6',
            'earth1','earth2','earth3','earth4','earth5','earth6','earth7'), 
    results=c(RMSE(lm1),RMSE(lm2),RMSE(lm3),RMSE(lm4),RMSE(lm5),RMSE(lm6),RMSE(earth1),
              RMSE(earth2),RMSE(earth3),RMSE(earth4),RMSE(earth5),RMSE(earth6),RMSE(earth7)))

############### Estimate on the full dataset #####################
chosenModel2<-earth(card~.,data = RawData1B,degree = 2)
chosenModel2
```


```{r}
#Fill in your student number in the line below to generate the RData file for submission. DO NOT CHANGE ANYTHING ELSE ABOUT THE CODE BELOW.
studentNum = 31625937 #Student number goes just before this 

#This reduces the file size in some cases fringe cases
chosenModel$cv.list = NULL
chosenModel$cv.oof.fit.tab = NULL
chosenModel$varmod = NULL

chosenModel2$cv.list = NULL
chosenModel2$cv.oof.fit.tab = NULL
chosenModel2$varmod = NULL

save(chosenModel, chosenModel2, file = paste0(studentNum,'.Rdata'))

#The following code checks if you generated the models correctly.  Run it, and if you see 'looks good!' pop up twice then your Rdata file is ready. Do not alter it any way - not even to change the variable names.  If not, please correct, or contact the TAs for help 
load(paste0(studentNum,'.Rdata'))
rightType = class(chosenModel)=='earth'|class(chosenModel)=='lm'
rightType2 = class(chosenModel2)=='earth'|class(chosenModel2)=='lm'
if(class(chosenModel)=='earth'){
	noExpend = !grepl('[^-]expenditure',paste(rownames(chosenModel$coefficients),collapse=''))
}  else {
	noExpend = !grepl('[^-]expenditure',paste(names(chosenModel$coefficients),collapse=''))
}

if(rightType&rightType2&noExpend){ 
	print('Looks Good!')
} else {
	print('Mistake - Check that you are saving lm and earth models, and that expenditure is not in the first model')
}

```